---
title: Handling Multiple Authentication Policies
sidebar_label: Multiple Auth Policies
description:
  Learn how to configure multiple authentication methods like JWT and API Key on
  a single API route in Zuplo.
tags:
  - authentication
---

Sometimes multiple types of authentication are needed on an API.

## JWT and API Key Authentication

JWT and API Key authentication can be handled by adding three policies to a route (or using [composite policies](../policies/composite-inbound.mdx) to keep everything organized).

1. [API Key Authentication Policy](../policies/api-key-inbound.mdx)
1. [Any JWT Authentication Policy](../policies/open-id-jwt-auth-inbound.mdx)
1. [A Custom Policy](../policies/custom-code-inbound.mdx)

:::warning

The order of these policies is critical. Placing them in the wrong order can cause errors or lead to security issues.

:::

All of the Zuplo built-in authentication policies have an option called `allowUnauthenticatedRequests`.

:::tip

The option `allowUnauthenticatedRequests` can also be used to make a route work for both authenticated and anonymous users.

:::

In the route that handles multiple authentication policies, add the API Key Authentication policy and the JWT Authentication policy of your choice (for example Auth0, Okta, Cognito, etc.).

Configure the other options as usual.

Finally, if the route **requires** authentication, a third policy is necessary to enforce that after both authentication policies run, the request has been authenticated.

To enforce authentication, check that the value of `request.user.sub` is as expected.

```ts
import { ZuploContext, ZuploRequest } from "@zuplo/runtime";

export default async function (request: ZuploRequest, context: ZuploContext) {
  if (!request.user?.sub) {
    return new Response("Unauthorized", { status: 401 });
  }
}
```

### Multiple JWT Authentication Policies

Multiple JWT authentication policies is slightly more challenging than adding JWT and API key authentication because JWT authentication performs validation on the token value.
